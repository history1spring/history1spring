<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÏπºÎ¶ºÎ∞î ÌôîÏùå ÏóêÎîîÏÖò (Fix)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&family=Nunito:wght@700&display=swap');

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #141e30 0%, #243b55 100%);
            font-family: 'Jua', 'Nunito', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        body::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.3;
            z-index: -1;
        }

        .top-ui {
            width: 90%;
            max-width: 650px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            z-index: 10;
        }

        .title-area h1 {
            color: #fff;
            font-size: 2.2rem;
            margin: 0;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        .title-area p {
            color: #88c0d0;
            margin: 5px 0 0 0;
            font-size: 1rem;
        }

        .volume-control {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            color: white;
        }
        input[type=range] {
            width: 120px;
            accent-color: #88c0d0;
        }

        .kalimba-body {
            position: relative;
            width: 90%;
            max-width: 650px;
            height: 480px;
            background-color: #5c3a21;
            background-image: 
                repeating-linear-gradient(45deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 2px, transparent 2px, transparent 10px),
                radial-gradient(circle at center, #8b5a2b 0%, #3d2314 100%);
            border-radius: 40px 40px 80px 80px;
            box-shadow: 
                0 30px 60px rgba(0,0,0,0.8), 
                inset 0 0 60px rgba(0,0,0,0.9),
                inset 0 0 10px rgba(255,255,255,0.1);
            display: flex;
            justify-content: center;
            padding-top: 60px;
            border: 5px solid #2a150b;
        }

        .sound-hole {
            position: absolute;
            top: 260px;
            width: 140px;
            height: 140px;
            background: radial-gradient(circle at 50% 50%, #1a0f08, #000);
            border-radius: 50%;
            box-shadow: inset 0 5px 15px rgba(0,0,0,1), 0 2px 5px rgba(255,255,255,0.05);
            z-index: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .sound-hole::after {
            content: 'Polyphony';
            color: rgba(255,255,255,0.1);
            font-size: 18px;
            letter-spacing: 1px;
        }

        .bridge {
            position: absolute;
            top: 80px;
            width: 85%;
            height: 20px;
            background: linear-gradient(to bottom, #d7d7d7, #8c8c8c, #333);
            border-radius: 5px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.7);
            z-index: 2;
        }

        .keys-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            z-index: 3;
            position: relative;
        }

        .key {
            width: 30px;
            margin: 0 2px;
            background: linear-gradient(180deg, #e3e3e3 0%, #fff 50%, #b0b0b0 100%);
            border-radius: 0 0 8px 8px;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 15px;
            color: #333;
            box-shadow: 0 5px 10px rgba(0,0,0,0.6), inset 0 0 5px rgba(255,255,255,0.8);
            transition: transform 0.05s, background 0.05s;
            transform-origin: top center;
        }

        .note-label { font-size: 14px; font-weight: 800; margin-bottom: 4px; font-family: 'Nunito', sans-serif; }
        .key-bind {
            font-size: 10px; color: #666; background: rgba(255,255,255,0.8);
            padding: 2px 5px; border-radius: 4px; margin-bottom: 5px; font-weight: bold;
        }

        .key.active {
            transform: scaleY(0.97) translateY(2px);
            background: linear-gradient(180deg, #81fbb8 0%, #28c76f 100%); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.4), 0 0 15px rgba(40, 199, 111, 0.6);
        }

        .instruction {
            position: absolute; bottom: 20px; color: rgba(255,255,255,0.5); font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="top-ui">
        <div class="title-area">
            <h1>Kalimba</h1>
            <p>ÌôîÏùå(Chord) Ïó∞Ï£º ÏµúÏ†ÅÌôî</p>
        </div>
        <div class="volume-control">
            <span>Volume</span>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.8">
        </div>
    </div>

    <div class="kalimba-body">
        <div class="bridge"></div>
        <div class="sound-hole"></div>
        <div class="keys-container" id="keysContainer"></div>
        <div class="instruction">ÌÇ§Î≥¥ÎìúÎ•º ÎèôÏãúÏóê ÎàåÎü¨ ÌôîÏùåÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî</div>
    </div>

    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        // üéõÔ∏è Ïò§ÎîîÏò§ Ïª¥ÌîÑÎ†àÏÑú (ÌôîÏùå Ï∞¢Ïñ¥Ïßê Î∞©ÏßÄ)
        const compressor = audioCtx.createDynamicsCompressor();
        compressor.threshold.setValueAtTime(-24, audioCtx.currentTime);
        compressor.knee.setValueAtTime(30, audioCtx.currentTime);
        compressor.ratio.setValueAtTime(12, audioCtx.currentTime);
        compressor.attack.setValueAtTime(0.003, audioCtx.currentTime);
        compressor.release.setValueAtTime(0.25, audioCtx.currentTime);

        const masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.8;

        compressor.connect(masterGain);
        masterGain.connect(audioCtx.destination);

        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            masterGain.gain.value = e.target.value;
        });

        // 17ÏùåÍ≥Ñ Îç∞Ïù¥ÌÑ∞
        const notes = [
            { note: "D6", freq: 1174.66, label: "2ÀôÀô", height: 200, key: "q" },
            { note: "B5", freq: 987.77, label: "7Àô", height: 215, key: "w" },
            { note: "G5", freq: 783.99, label: "5Àô", height: 230, key: "e" },
            { note: "E5", freq: 659.25, label: "3Àô", height: 245, key: "r" },
            { note: "C5", freq: 523.25, label: "1Àô", height: 260, key: "t" },
            { note: "A4", freq: 440.00, label: "6", height: 275, key: "y" },
            { note: "F4", freq: 349.23, label: "4", height: 290, key: "u" },
            { note: "D4", freq: 293.66, label: "2", height: 305, key: "i" },
            { note: "C4", freq: 261.63, label: "1", height: 320, key: "o" },
            { note: "E4", freq: 329.63, label: "3", height: 305, key: "p" },
            { note: "G4", freq: 391.99, label: "5", height: 290, key: "a" },
            { note: "B4", freq: 493.88, label: "7", height: 275, key: "s" },
            { note: "D5", freq: 587.33, label: "2Àô", height: 260, key: "d" },
            { note: "F5", freq: 698.46, label: "4Àô", height: 245, key: "f" },
            { note: "A5", freq: 880.00, label: "6Àô", height: 230, key: "g" },
            { note: "C6", freq: 1046.50, label: "1ÀôÀô", height: 215, key: "h" },
            { note: "E6", freq: 1318.51, label: "3ÀôÀô", height: 200, key: "j" }
        ];

        // ÌÉÄÍ≤©ÏùåÏö© ÎÖ∏Ïù¥Ï¶à Î≤ÑÌçº
        const bufferSize = audioCtx.sampleRate * 2.0;
        const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            output[i] = Math.random() * 2 - 1;
        }

        function playTone(freq) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;

            // 1. Í∏∞Î≥∏Ïùå
            const oscBase = audioCtx.createOscillator();
            const gainBase = audioCtx.createGain();
            oscBase.type = 'sine';
            oscBase.frequency.value = freq;
            gainBase.gain.setValueAtTime(0, now);
            gainBase.gain.linearRampToValueAtTime(0.6, now + 0.005);
            gainBase.gain.exponentialRampToValueAtTime(0.001, now + 3.0);
            oscBase.connect(gainBase);
            gainBase.connect(compressor);
            oscBase.start(now);
            oscBase.stop(now + 3.1);

            // 2. Î∞∞Ïùå
            const oscMetal = audioCtx.createOscillator();
            const gainMetal = audioCtx.createGain();
            oscMetal.type = 'sine';
            oscMetal.frequency.value = freq * 2.1;
            gainMetal.gain.setValueAtTime(0, now);
            gainMetal.gain.linearRampToValueAtTime(0.15, now + 0.01);
            gainMetal.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
            oscMetal.connect(gainMetal);
            gainMetal.connect(compressor);
            oscMetal.start(now);
            oscMetal.stop(now + 0.9);

            // 3. ÌÉÄÍ≤©Ïùå
            const noiseSrc = audioCtx.createBufferSource();
            noiseSrc.buffer = noiseBuffer;
            const noiseGain = audioCtx.createGain();
            const impactVol = Math.min(0.3, freq / 2000); 
            noiseGain.gain.setValueAtTime(0, now);
            noiseGain.gain.linearRampToValueAtTime(impactVol, now + 0.001);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.03);
            
            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'lowpass';
            noiseFilter.frequency.value = 3000;

            noiseSrc.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(compressor);
            noiseSrc.start(now);
            noiseSrc.stop(now + 0.05);
        }

        const container = document.getElementById('keysContainer');
        const keyElements = {};

        notes.forEach((n) => {
            const keyDiv = document.createElement('div');
            keyDiv.className = 'key';
            keyDiv.style.height = n.height + 'px';
            keyDiv.innerHTML = `<span class="note-label">${n.label}</span><span class="key-bind">${n.key.toUpperCase()}</span>`;
            
            const playHandler = (e) => {
                if (e.type !== 'keydown') e.preventDefault();
                playTone(n.freq);
                visualEffect(keyDiv);
            };

            keyDiv.addEventListener('mousedown', playHandler);
            keyDiv.addEventListener('touchstart', playHandler);
            container.appendChild(keyDiv);
            keyElements[n.key] = { div: keyDiv, freq: n.freq };
        });

        // üõ†Ô∏è ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ: 0.15Ï¥à Îí§Ïóê ÏûêÎèôÏúºÎ°ú Ïò¨ÎùºÏò§Í≤å ÏÑ§Ï†ï
        function visualEffect(div) {
            // Ïù¥ÎØ∏ ÎàåÎ†§ÏûàÎäî ÏÉÅÌÉúÎùºÎ©¥ ÏùºÎã® Ï¥àÍ∏∞Ìôî (Ïó∞ÌÉÄ Ïãú Î∞òÏùëÏÑ± ÏúÑÌï¥)
            div.classList.remove('active');
            void div.offsetWidth; // Í∞ïÏ†ú Î¶¨ÌîåÎ°úÏö∞ (Ïï†ÎãàÎ©îÏù¥ÏÖò Î¶¨ÏÖã)
            
            div.classList.add('active'); // ÎàÑÎ¶Ñ Ìö®Í≥º Ï†ÅÏö©
            
            // 0.15Ï¥à Îí§Ïóê ÏûêÎèôÏúºÎ°ú ÏõêÏÉÅÎ≥µÍµ¨ (Ïó¨Í∏∞Í∞Ä Îπ†Ï†∏ÏûàÏóàÏäµÎãàÎã§!)
            setTimeout(() => {
                div.classList.remove('active');
            }, 150);
        }

        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (keyElements[key] && !e.repeat) {
                playTone(keyElements[key].freq);
                visualEffect(keyElements[key].div);
            }
        });
    </script>
</body>
</html>